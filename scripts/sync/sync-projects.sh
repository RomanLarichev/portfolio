#!/bin/bash
set -e  # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ÑÑ Ð¿Ñ€Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐ°Ñ…

echo "ðŸ”„ ÐÐ°Ñ‡Ð¸Ð½Ð°ÑŽ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸ÑŽ Ð¿Ð¾Ñ€Ñ‚Ñ„Ð¾Ð»Ð¸Ð¾..."

# Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ Ð¿Ð°Ð¿ÐºÑƒ
TEMP_DIR=$(mktemp -d)
cd "$TEMP_DIR"

# ÐœÐ°ÑÑÐ¸Ð² Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð¾Ð² Ð´Ð»Ñ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ð¸
# Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: "Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹|Ð¿Ð°Ð¿ÐºÐ°_Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ|Ð²ÐµÑ‚ÐºÐ°"
PROJECTS=(
    # Ð’ÐµÐ±-Ð¿Ñ€Ð¾ÐµÐºÑ‚Ñ‹
    "Ð²Ð°Ñˆ_Ð»Ð¾Ð³Ð¸Ð½/Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ_Ð²ÐµÐ±_Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°|web/Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ_Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°|main"
    
    # ÐœÐ¾Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ñ‹
    "Ð²Ð°Ñˆ_Ð»Ð¾Ð³Ð¸Ð½/Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ_Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ð¾Ð³Ð¾_Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ|mobile/Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ_Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ|main"
    
    # Ð¡ÐºÑ€Ð¸Ð¿Ñ‚Ñ‹
    "Ð²Ð°Ñˆ_Ð»Ð¾Ð³Ð¸Ð½/ÑÐºÑ€Ð¸Ð¿Ñ‚Ñ‹_Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ð¸|scripts/automation|main"
)

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
sync_project() {
    local repo=$1
    local target=$2
    local branch=$3
    
    echo "ðŸ“¦ Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð¸Ñ€ÑƒÑŽ $repo Ð² $target..."
    
    # ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² Ð¿Ð¾Ñ€Ñ‚Ñ„Ð¾Ð»Ð¸Ð¾
    cd "$GITHUB_WORKSPACE"
    
    # Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€ÑƒÑŽ Ð¿Ð°Ð¿ÐºÑƒ, ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ
    rm -rf "$target"
    
    # ÐšÐ»Ð¾Ð½Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚
    git clone --depth 1 --branch "$branch" "https://github.com/$repo.git" "$target"
    
    # Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÐ»ÑƒÐ¶ÐµÐ±Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
    rm -rf "$target/.git"
    rm -rf "$target/.github" 2>/dev/null || true
    
    # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð¼ÐµÑ‚Ð°-Ñ„Ð°Ð¹Ð» Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÐµÐ¹ Ð¾ Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸ÐºÐµ
    cat > "$target/.portfolio-source.md" << EOM
# ðŸ·ï¸ Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ðµ

Ð­Ñ‚Ð¾Ñ‚ Ð¿Ñ€Ð¾ÐµÐºÑ‚ Ð±Ñ‹Ð» Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½ Ð¸Ð· Ð²Ð½ÐµÑˆÐ½ÐµÐ³Ð¾ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ.

**Ð˜ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº:** https://github.com/$repo  
**Ð’ÐµÑ‚ÐºÐ°:** $branch  
**ÐŸÐ¾ÑÐ»ÐµÐ´Ð½ÑÑ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ:** $(date)

**Ð’Ð°Ð¶Ð½Ð¾:** ÐÐµ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð² ÑÑ‚Ð¾Ð¹ Ð¿Ð°Ð¿ÐºÐµ Ð½Ð°Ð¿Ñ€ÑÐ¼ÑƒÑŽ.
Ð’Ð½Ð¾ÑÐ¸Ñ‚Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð² Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹.
EOM
    
    echo "âœ… $repo ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½"
}

# Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑŽ Ð´Ð»Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ Ð² xargs
export -f sync_project
export GITHUB_WORKSPACE="$(pwd)/.."

# Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ð²ÑÐµ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ñ‹
for project in "${PROJECTS[@]}"; do
    IFS='|' read -r repo target branch <<< "$project"
    sync_project "$repo" "$target" "$branch"
done

# ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
cd ..
rm -rf "$TEMP_DIR"

echo "ðŸŽ‰ Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!"
